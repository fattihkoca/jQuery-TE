/*!
 * http://jqueryte.com
 * jQuery TE 1.2
 * Copyright (C) 2012, Fatih Koca (fatihkoca@me.com), AUTHOR.txt (http://jqueryte.com/about)
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
You should have received a copy of the GNU General Public License along with this library; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
*/
(function(e){e.fn.jqte=function(t){function s(e,t,n,r,s,o){return i.push({name:e,cls:t,command:n,key:r,tag:s,emphasis:o})}var n=[{title:"Bold",hotkey:"B"},{title:"Italic",hotkey:"I"},{title:"Underline",hotkey:"U"},{title:"Ordered List",hotkey:"."},{title:"Unordered List",hotkey:","},{title:"Subscript",hotkey:"down arrow"},{title:"Superscript",hotkey:"up arrow"},{title:"Outdent",hotkey:"left arrow"},{title:"Indent",hotkey:"right arrow"},{title:"Strike Through",hotkey:"K"},{title:"Add Link",hotkey:"L"},{title:"Remove Link",hotkey:""},{title:"Cleaner Style",hotkey:"Delete"},{title:"Horizontal Rule",hotkey:"H"},{title:"Source",hotkey:""}];var r=e.extend({css:"jqte",title:true,titletext:n,button:"OK",b:true,i:true,u:true,ol:true,ul:true,sub:true,sup:true,outdent:true,indent:true,strike:true,link:true,unlink:true,remove:true,rule:true,source:true},t);var i=[];s("b","1","Bold","B",["b","strong"],true);s("i","2","Italic","I",["i","em"],true);s("u","3","Underline","U",["u"],true);s("ol","4","insertorderedlist","¾",["ol"],true);s("ul","5","insertunorderedlist","¼",["ul"],true);s("sub","6","subscript","(",["sub"],true);s("sup","7","superscript","&",["sup"],true);s("outdent","8","outdent","%",["blockquote"],false);s("indent","9","indent","'",["blockquote"],true);s("strike","10","strikeThrough","K",["strike"],true);s("link","11","createlink","L",["a"],true);s("unlink","12","unlink","",["a"],false);s("remove","13","removeformat",".","",false);s("rule","14","inserthorizontalrule","H",["hr"],false);s("source","15","displaysource","J","",false);return this.each(function(){function g(e){var t,n,r=null,i=navigator.userAgent.toLowerCase();if(window.getSelection){n=window.getSelection();if(n.anchorNode&&n.getRangeAt)t=n.getRangeAt(0);if(t){n.removeAllRanges();n.addRange(t)}if(e=="createlink")r=b(t);if(!i.match(/msie/))document.execCommand("StyleWithCSS",false,false);document.execCommand(e,false,r)}else if(document.selection&&document.selection.createRange&&document.selection.type!="None"){t=document.selection.createRange();if(e=="createlink")r=b(t);t.execCommand(e,false,r)}}function b(){var e="http://";var t=y();if(t){var n=t.prop("tagName").toLowerCase();if(n=="a"&&t.is("[href]"))e=t.attr("href")}return prompt("URL:",e)}function w(e){var t,n,r;t=e.replace(/\n/g,"").replace(/\r/g,"").replace(/\t/g,"").replace(/<p><\/p>/g,"").replace(/ /g," ").replace(/<p> <\/p>/g,"");n=[/\<div>(.*?)\<\/div>/ig,/\<br>(.*?)\<br>/ig,/\<br\/>(.*?)\<br\/>/ig,/\<strong>(.*?)\<\/strong>/ig,/\<em>(.*?)\<\/em>/ig];r=["<p>$1</p>","<p>$1</p>","<p>$1</p>","<b>$1</b>","<i>$1</i>"];for(var i=0;i<n.length;i++){t=t.replace(n[i],r[i])}return t}function E(){t.val(w(f.html()))}function S(){f.html(w(t.val()))}function x(t){var n=false,r=y(),i,s;if(r){e.each(t,function(t,o){i=r.prop("tagName").toLowerCase();s=r.attr("style");if(i==o)n=true;else{r.parents().each(function(){i=e(this).prop("tagName").toLowerCase();if(i==o)n=true})}});return n}else return false}function T(t){for(var n=0;n<i.length;n++){if(r[i[n].name]&&i[n].emphasis&&i[n].tag!="")x(i[n].tag)?s.find("."+r.css+"_tool_"+i[n].cls).addClass(l):e("."+r.css+"_tool_"+i[n].cls).removeClass(l)}}var t=e(this);t.after('<div class="'+r.css+'" ></div>');var n=t.next("."+r.css);n.html('<div class="'+r.css+"_toolbar"+'" role="toolbar" unselectable></div><div class="'+r.css+"_editor"+'"></div>');var s=n.find("."+r.css+"_toolbar");var o=n.find("."+r.css+"_linkform");var u=o.find("."+r.css+"_linkinput");var a=o.find("."+r.css+"_linkbutton");var f=n.find("."+r.css+"_editor");var l=r.css+"_tool_depressed";var c="user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;-o-user-select:none;";f.after('<div class="'+r.css+"_source "+r.css+'_hiddenField"></div>');var h=n.find("."+r.css+"_source");t.appendTo(h);f.attr("contenteditable","true").html(t.val());for(var p=0;p<i.length;p++){if(r[i[p].name]){var d=r.titletext[p].hotkey!=null&&r.titletext[p].hotkey!="undefined"&&r.titletext[p].hotkey!=""?" (Ctrl+"+r.titletext[p].hotkey+")":"";var v=r.titletext[p].title!=null&&r.titletext[p].title!="undefined"&&r.titletext[p].title!=""?r.titletext[p].title+d:"";s.append('<div class="'+r.css+"_tool "+r.css+"_tool_"+i[p].cls+'" role="button" data-tool="'+p+'" unselectable><a class="'+r.css+'_tool_icon" unselectable></a></div>');s.find("."+r.css+"_tool[data-tool="+p+"]").data({tag:i[p].tag,command:i[p].command,emphasis:i[p].emphasis,title:v})}}n.find("[unselectable]").attr({unselectable:"on",style:c}).on("selectstart mousedown",function(e){e.preventDefault()});var m=s.find("."+r.css+"_tool");var y=function(){var t,n;if(window.getSelection){n=getSelection();t=n.anchorNode}if(!t&&document.selection){n=document.selection;var r=n.getRangeAt?n.getRangeAt(0):n.createRange();t=r.commonAncestorContainer?r.commonAncestorContainer:r.parentElement?r.parentElement():r.item(0)}if(t){return t.nodeName=="#text"?e(t.parentNode):e(t)}else return false};m.click(function(){if(e(this).data("command")=="displaysource"&&!s.data("sourceOpened")){s.find("."+r.css+"_tool").addClass(r.css+"_hiddenField");e(this).removeClass(r.css+"_hiddenField");s.data("sourceOpened",true);h.removeClass(r.css+"_hiddenField");f.addClass(r.css+"_hiddenField");t.focus();E()}else{if(e(this).data("command")!=""&&e(this).data("command")!="displaysource")g(e(this).data("command"));e(this).data("emphasis")==true&&!e(this).hasClass(l)?e(this).addClass(l):e(this).removeClass(l);h.addClass(r.css+"_hiddenField");f.removeClass(r.css+"_hiddenField");if(f.not(":focus"))f.focus();s.data("sourceOpened",false);s.find("."+r.css+"_tool").removeClass(r.css+"_hiddenField");E()}}).hover(function(){if(r.title&&e(this).data("title")!=""){e("."+r.css+"_title").remove();n.append('<div class="'+r.css+'_title"><div class="'+r.css+'_titleArrow"><div class="'+r.css+'_titleArrowIcon"></div></div><div class="'+r.css+'_titleText">'+e(this).data("title")+"</div></div>");var t=e("."+r.css+"_title:first");var i=t.find("."+r.css+"_titleArrowIcon");var s=e(this).position();var o=s.left+e(this).outerWidth()-t.outerWidth()/2-e(this).outerWidth()/2;var u=s.top+e(this).outerHeight()+5;t.delay(400).css({top:u,left:o}).fadeIn(200)}},function(){e("."+r.css+"_title").remove()});f.bind("keypress keyup keydown drop cut copy paste DOMCharacterDataModified DOMSubtreeModified",function(){if(!s.data("sourceOpened"))e(this).trigger("change")}).bind("change",function(){if(!s.data("sourceOpened"))setTimeout(E,0)}).keydown(function(e){for(var t=0;t<i.length;t++){if(r[i[t].name]){if(e.keyCode==i[t].key.charCodeAt(0)&&e.ctrlKey&&i[t].command!=""){g(i[t].command);return false}}}}).bind("mouseup keyup",T).focusout(function(){m.removeClass(l)});t.bind("keydown keyup",function(){setTimeout(S,0);e(this).height(e(this)[0].scrollHeight);if(e(this).val()=="")e(this).height(0)})})}})(jQuery)